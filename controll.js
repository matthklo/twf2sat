
forecast_sites = {
    '0': {
        '新北': [
                {'id':"D115", 'site':"三角崙山"},
                {'id':"D114", 'site':"三貂嶺"},
                {'id':"D109", 'site':"五分山"},
                {'id':"D112", 'site':"大桶山"},
                {'id':"D113", 'site':"波路山"},
                {'id':"D116", 'site':"燦光寮山"},
                {'id':"D111", 'site':"磺嘴山"},
                {'id':"D110", 'site':"竹子山"},
                {'id':"D144", 'site':"十八尖山"}
        ],
        '新竹': [
                {'id':"D074", 'site':"伊澤山"},
                {'id':"D145", 'site':"向天湖山"},
                {'id':"D079", 'site':"喀拉業山"},
                {'id':"D149", 'site':"李棟山"},
                {'id':"D077", 'site':"桃山"},
                {'id':"D075", 'site':"池有山"},
                {'id':"D150", 'site':"烏來山"},
                {'id':"D148", 'site':"虎禮山"},
                {'id':"D147", 'site':"霞喀羅大山"},
                {'id':"D146", 'site':"霞山"}
        ],
        '桃園': [
                {'id':"D137", 'site':"低陸山"},
                {'id':"D143", 'site':"塔曼山"},
                {'id':"D136", 'site':"夫婦山"},
                {'id':"D139", 'site':"拉拉山"},
                {'id':"D142", 'site':"插天山"},
                {'id':"D140", 'site':"東眼山"},
                {'id':"D124", 'site':"檜山"},
                {'id':"D134", 'site':"石牛山"},
                {'id':"D138", 'site':"良羽鳥山"},
                {'id':"D135", 'site':"金面山"},
                {'id':"D141", 'site':"馬望曾呂山"}
        ],
        '臺北': [
                {'id':"D106", 'site':"七星山"},
                {'id':"D104", 'site':"劍潭山"},
                {'id':"D108", 'site':"南港山"},
                {'id':"D102", 'site':"大屯山"},
                {'id':"D107", 'site':"山豬窟山"},
                {'id':"D125", 'site':"石尖山"},
                {'id':"D103", 'site':"紗帽山"},
                {'id':"D105", 'site':"蟾蜍山"}
        ],
        '苗栗': [
                {'id':"D049", 'site':"中雪山"},
                {'id':"D132", 'site':"佳仁山"},
                {'id':"D051", 'site':"加利山"},
                {'id':"D128", 'site':"加里山"},
                {'id':"D129", 'site':"北坑山"},
                {'id':"D048", 'site':"大雪山"},
                {'id':"D072", 'site':"大霸尖山"},
                {'id':"D131", 'site':"東陽山"},
                {'id':"D050", 'site':"火石山"},
                {'id':"D126", 'site':"班山"},
                {'id':"D130", 'site':"老松山"},
                {'id':"D133", 'site':"能甲山"},
                {'id':"D078", 'site':"雪山"},
                {'id':"D127", 'site':"馬那邦山"}
        ]
    },
    '1': {
        '南投': [
                {'id':"D023", 'site':"丹大山"},
                {'id':"D011", 'site':"光頭山"},
                {'id':"D020", 'site':"八通關山"},
                {'id':"D025", 'site':"六順山"},
                {'id':"D031", 'site':"卓社大山"},
                {'id':"D061", 'site':"南大水窟山"},
                {'id':"D028", 'site':"合歡山"},
                {'id':"D029", 'site':"合歡山東峰"},
                {'id':"D088", 'site':"合歡山西峰"},
                {'id':"D021", 'site':"大水窟山"},
                {'id':"D014", 'site':"奇萊主山南峰"},
                {'id':"D022", 'site':"干卓萬山"},
                {'id':"D033", 'site':"東巒大山"},
                {'id':"D032", 'site':"東郡大山"},
                {'id':"D042", 'site':"無雙山"},
                {'id':"D034", 'site':"牧山"},
                {'id':"D083", 'site':"玉山前峰"},
                {'id':"D026", 'site':"玉山北峰"},
                {'id':"D082", 'site':"玉山東峰"},
                {'id':"D081", 'site':"玉山西峰"},
                {'id':"D094", 'site':"畢祿山"},
                {'id':"D086", 'site':"白姑大山"},
                {'id':"D009", 'site':"白石山"},
                {'id':"D030", 'site':"秀姑巒山"},
                {'id':"D044", 'site':"義西請馬至山"},
                {'id':"D038", 'site':"能高北峰"},
                {'id':"D037", 'site':"能高山主峰"},
                {'id':"D018", 'site':"能高山南峰"},
                {'id':"D043", 'site':"萬東山西峰"},
                {'id':"D046", 'site':"西巒大山"},
                {'id':"D068", 'site':"達芬尖山"},
                {'id':"D039", 'site':"郡大山"},
                {'id':"D040", 'site':"馬利加南山"},
                {'id':"D041", 'site':"馬博拉斯山"},
                {'id':"D045", 'site':"駒盆山"}
        ],
        '嘉義': [
                {'id':"D080", 'site':"玉山"}
        ],
        '臺中': [
                {'id':"D001", 'site':"中央尖山"},
                {'id':"D091", 'site':"佳陽山"},
                {'id':"D097", 'site':"劍山"},
                {'id':"D003", 'site':"南湖大山"},
                {'id':"D004", 'site':"南湖大山南峰"},
                {'id':"D092", 'site':"南湖大山東峰"},
                {'id':"D076", 'site':"品田山"},
                {'id':"D084", 'site':"大劍山"},
                {'id':"D073", 'site':"小霸尖山"},
                {'id':"D002", 'site':"巴巴山"},
                {'id':"D090", 'site':"志佳陽大山"},
                {'id':"D095", 'site':"無明山"},
                {'id':"D085", 'site':"甘薯峰"},
                {'id':"D096", 'site':"鈴鳴山"},
                {'id':"D093", 'site':"閂山"},
                {'id':"D052", 'site':"雪山北峰"},
                {'id':"D053", 'site':"雪山東峰"},
                {'id':"D054", 'site':"頭鷹山"}
        ]
    },
    '2': {
        '屏東': [
                {'id':"D047", 'site':"大武山"}
        ],
        '高雄': [
                {'id':"D055", 'site':"三叉山"},
                {'id':"D059", 'site':"卑南主山"},
                {'id':"D035", 'site':"南玉山"},
                {'id':"D036", 'site':"南雙頭山"},
                {'id':"D058", 'site':"向陽山"},
                {'id':"D066", 'site':"塔芬山"},
                {'id':"D067", 'site':"塔關山"},
                {'id':"D056", 'site':"小關山"},
                {'id':"D062", 'site':"庫哈諾辛山"},
                {'id':"D060", 'site':"東小南山"},
                {'id':"D063", 'site':"海諾南山"},
                {'id':"D057", 'site':"玉山南峰"},
                {'id':"D069", 'site':"轆轆山"},
                {'id':"D070", 'site':"關山"},
                {'id':"D071", 'site':"關山嶺山"},
                {'id':"D065", 'site':"雲峰"},
                {'id':"D064", 'site':"鹿山"}
        ]
    },
    '3': {
        '宜蘭': [
                {'id':"D005", 'site':"南湖北山"},
                {'id':"D119", 'site':"唐穗山"},
                {'id':"D123", 'site':"多加神山"},
                {'id':"D007", 'site':"審馬陣山"},
                {'id':"D120", 'site':"望洋山"},
                {'id':"D118", 'site':"盆盆山"},
                {'id':"D121", 'site':"銅山"},
                {'id':"D117", 'site':"阿玉山"},
                {'id':"D122", 'site':"馬望來山"},
                {'id':"D006", 'site':"馬比杉山"}
        ],
        '花蓮': [
                {'id':"D024", 'site':"內嶺爾山"},
                {'id':"D087", 'site':"合歡山北峰"},
                {'id':"D100", 'site':"喀西帕南山"},
                {'id':"D008", 'site':"太魯閣大山"},
                {'id':"D013", 'site':"奇萊主山北峰"},
                {'id':"D015", 'site':"奇萊主峰"},
                {'id':"D012", 'site':"安東軍山"},
                {'id':"D017", 'site':"屏風山"},
                {'id':"D098", 'site':"布拉克桑山"},
                {'id':"D016", 'site':"帕托魯山"},
                {'id':"D101", 'site':"新康山"},
                {'id':"D027", 'site':"石門山"},
                {'id':"D019", 'site':"磐石山"},
                {'id':"D010", 'site':"立霧主山"},
                {'id':"D089", 'site':"羊頭山"},
                {'id':"D099", 'site':"馬西山"}
        ]
    }
}

function resolve_site_name(site_id)
{
    for (var ridx in forecast_sites)
    {
        var region = forecast_sites[ridx];
        for (var cidx in region)
        {
            var city = region[cidx];
            for (var i=0; i<city.length; ++i)
            {
                if (city[i].id == site_id)
                    return city[i].site;
            }
        }
    }
    return "";
}

function datetimepicker_start_date_changed(evt)
{
    // Note: evt.date: current picked dated. evt.oldDate: old date.
    $('#datetimepicker-end').datetimepicker('maxDate', false);
    $('#datetimepicker-end').datetimepicker('minDate', false);
    $('#datetimepicker-end').datetimepicker('date', evt.date);
    $('#datetimepicker-end').datetimepicker('maxDate', new Date(evt.date.toDate().getTime() + 30*86400000));
    $('#datetimepicker-end').datetimepicker('minDate', evt.date);
    validate();
}

function datetimepicker_end_date_changed(evt)
{
    validate();
}

function handle_region_selection_change(evt)
{
    inner_html = '<option value="" selected>選擇...</option>';
    $(inputGroupMountain).html(inner_html);

    if (evt.target.value != "")
    {
        var cities = forecast_sites[evt.target.value];
        $.each(cities, function(k,v) {
            var option = '<option>' + k + '</option>';
            inner_html += option;
        });
    }
    $(inputGroupCity).html(inner_html);

    validate();
}

function handle_city_selection_change(evt)
{
    inner_html = '<option value="" selected>選擇...</option>';

    if (evt.target.value != "")
    {
        var selected_region = $('#inputGroupRegion').get(0).value;
        var sites = forecast_sites[selected_region][evt.target.value];
        $.each(sites, function(idx,val) {
            var option = '<option value="' + val.id + '">' + val.site + '</option>';
            inner_html += option;
        });
    }
    $(inputGroupMountain).html(inner_html);

    validate();
}

function handle_mountain_selection_change(evt)
{
    validate();
}

function handle_tel_change(evt)
{
    validate();
}

function handle_tel_query_change(evt)
{
    validate();
}

function validate()
{
    var tel_valid = false;
    var enterred_tel = $('#inputGroupTel').get(0).value;
    if (enterred_tel == "" || ($.isNumeric(enterred_tel) && enterred_tel.length == 8))
    {
        $('#tel-alert').addClass('d-none');
        if (enterred_tel != "")
            tel_valid = true;
    }
    else
    {
        $('#tel-alert').removeClass('d-none');
    }

    var tel_query_valid = false;
    var enterred_query_tel = $('#inputGroupTelQuery').get(0).value;
    if (enterred_query_tel == "" || ($.isNumeric(enterred_query_tel) && enterred_query_tel.length == 8))
    {
        $('#tel-alert-query').addClass('d-none');
        if (enterred_query_tel != "")
            tel_query_valid = true;
    }
    else
    {
        $('#tel-alert-query').removeClass('d-none');
    }

    var regionChoosed = false;
    var cityChoosed = false;
    var mountainChoosed = false;
    if ($('#inputGroupRegion').get(0).value == "")
    {
        $('#inputGroupCity').prop('disabled', true);
        $('#inputGroupMountain').prop('disabled', true);
    }
    else
    {
        regionChoosed = true;
        $('#inputGroupCity').prop('disabled', false);
    }

    if ($('#inputGroupCity').get(0).value == "")
    {
        $('#inputGroupMountain').prop('disabled', true);
    }
    else
    {
        cityChoosed = true;
        $('#inputGroupMountain').prop('disabled', false);
    }

    mountainChoosed = ($('#inputGroupMountain').get(0).value != "");

    if (regionChoosed && cityChoosed && mountainChoosed)
    {
        $('#forecast-alert').removeClass('d-none');

        var site_id = $('#inputGroupMountain').get(0).value;

        // Adjust href & target attrs of #forecast-link
        $('#forecast-link').prop('href', 'https://www.cwb.gov.tw/V7/forecast/entertainment/other/'+ site_id + '.htm')
            .prop('target', site_id);

    }
    else
    {
        $('#forecast-alert').addClass('d-none');
        $('#forecast-link').prop('href', '#');
    }

    // Final check on starting & ending date
    var date_valid = false;
    var cur_date = new Date();
    var default_starting_ms = new Date(cur_date.getFullYear(), cur_date.getMonth(), cur_date.getDate(), 0, 0, 0, 0).getTime();
    var start_ms = $('#datetimepicker-start').datetimepicker('date').toDate().getTime();
    var end_ms = $('#datetimepicker-end').datetimepicker('date').toDate().getTime();
    if ((start_ms >= default_starting_ms) && (end_ms >= start_ms)
        && (start_ms - default_starting_ms < 31*86400000) 
        && (end_ms - start_ms < 31*86400000))
    {
        date_valid = true;
    }

    if (tel_valid && regionChoosed && cityChoosed && mountainChoosed && date_valid)
    {
        $('#forecast-register-btn').prop('disabled', false);
    }
    else
    {
        $('#forecast-register-btn').prop('disabled', true);
    }

    $('#forecast-query-btn').prop('disabled', (tel_query_valid == false));
}

function handle_register_success(data, status, jqXHR)
{
    if (data.hasOwnProperty('error'))
    {
        show_result_modal('錯誤', '錯誤訊息: ' + data.error);
    }
    else
    {
        show_result_modal('成功', '已排程成功');

        localStorage.setItem("last_tel", $('#inputGroupTel').get(0).value);
    }

    $('#forecast-register-btn').prop('disabled', false);
    $('#register-spinner').addClass('d-none');
}

function handle_query_tel_success(data, status, jqXHR)
{
    $('#forecast-query-btn').prop('disabled', false);
    $('#query-spinner').addClass('d-none');

    if (data.hasOwnProperty('error'))
    {
        show_result_modal('查詢失敗', '錯誤訊息: ' + data.error);
        return;
    }

    localStorage.setItem("last_query_tel", $('#inputGroupTelQuery').get(0).value);

    // List all records.
    var inner_html = '<thead><tr><th scope="col">啟始時間</th><th scope="col">結束時間</th><th scope="col">山岳</th><th scope="col">動作</th></tr></thead>';
    var cells = '';
    for (var i =0; i<data.records.length; ++i)
    {
        var sd = new Date(data.records[i].start * 1000);
        var ed = new Date(data.records[i].end * 1000);
        cells += ('<tr><td>' + sd.toLocaleDateString() + '</td><td>' + ed.toLocaleDateString() 
            + '</td><td>' + resolve_site_name(data.records[i].site) 
            + '</td><td><button type="button" class="btn btn-outline-danger" data-revoke="'+ data.records[i].key + '">取消</button></td></tr>');
    }
    inner_html += ('<tbody>' + cells + '</tbody></table>');
    $('#query-result-table').removeClass('d-none').html(inner_html).on('click', 'button[data-revoke]', do_revoke);
}

function handle_query_count_success(data, status, jqXHR)
{

}

function handle_revoke_success(data, status, jqXHR)
{
    var candidate_records = $('button[data-revoke]').get();
    for (var idx in candidate_records)
    {
        if ($(candidate_records[idx]).data('revoke') == data.cancel)
        {
            $($(candidate_records[idx]).parents('tr').get(0)).remove();
            return;
        }
    }
}

function show_result_modal(title, message)
{
    $('#resultModalLabel').html(title);
    $('#resultModalBody').html(message);
    $('#resultModal').modal();
}

function do_register()
{
    // Send a POST request. Parameters: tel=xxxxxxxx&site=Dnnn&start=epoch&end=epoch
    payload = {
        tel: $('#inputGroupTel').get(0).value,
        site: $('#inputGroupMountain').get(0).value,
        start: $('#datetimepicker-start').datetimepicker('date').toDate().getTime() / 1000,
        end: $('#datetimepicker-end').datetimepicker('date').toDate().getTime() / 1000
    };

    $('#forecast-register-btn').prop('disabled', true);
    $('#register-spinner').removeClass('d-none');

    $.post("./api", $.param(payload), handle_register_success, "json")
}

function do_query_tel()
{
    payload = {
        query_tel: $('#inputGroupTelQuery').get(0).value
    }

    $('#forecast-query-btn').prop('disabled', true);
    $('#query-spinner').removeClass('d-none');

    $.post("./api", $.param(payload), handle_query_tel_success, "json")
}

function do_query_count()
{
    $.post("./api", "", handle_query_count_success, "json")
}

function do_revoke(evt)
{
    $(evt.target).html('<div class="spinner-border spinner-border-sm" role="status"></div>取消').prop('disabled', true);

    payload = {
        cancel: $(evt.target).data('revoke')
    }

    $.post("./api", $.param(payload), handle_revoke_success, "json")
}

function main()
{
    // From current date to compute the proper starting and ending date.
    var cur_date = new Date();
    var default_starting_date = new Date(cur_date.getFullYear(), cur_date.getMonth(), cur_date.getDate(), 0, 0, 0, 0);
    if (cur_date.getHours() >= 18)
        default_starting_date = new Date(default_starting_date.getTime() + 86400000);
    var default_ending_date = new Date(default_starting_date.getTime() + 3*86400000);

    // Initialize date time pickers, set locale / format / minDate / maxData / defaultDate.
    $('#datetimepicker-start').datetimepicker({
        locale: 'zh-tw', 
        format: 'L', 
        defaultDate: default_starting_date,
        minDate: default_starting_date,
        maxDate: new Date(default_starting_date.getTime() + 90*86400000)});
    $('#datetimepicker-end').datetimepicker({
        locale: 'zh-tw', 
        format: 'L', 
        defaultDate: default_ending_date,
        minDate: default_starting_date,
        maxDate: new Date(default_starting_date.getTime() + 30*86400000)});

    // Handle date picked events
    $('#datetimepicker-start').on('change.datetimepicker', datetimepicker_start_date_changed)
    $('#datetimepicker-end').on('change.datetimepicker', datetimepicker_end_date_changed)
    
    $('#inputGroupRegion').on('change', handle_region_selection_change);
    $('#inputGroupCity').on('change', handle_city_selection_change);
    $('#inputGroupMountain').on('change', handle_mountain_selection_change);
    $('#inputGroupTel').on('input', handle_tel_change);
    $('#inputGroupTelQuery').on('input', handle_tel_query_change);

    $('#forecast-register-btn').on('click', do_register);
    $('#forecast-query-btn').on('click', do_query_tel);

    // Fill last used tel
    var last_tel = localStorage.getItem("last_tel");
    if (last_tel != null)
    {
        $('#inputGroupTel').get(0).value = last_tel;
    }
    var last_query_tel = localStorage.getItem("last_query_tel");
    if (last_query_tel != null)
    {
        $('#inputGroupTelQuery').get(0).value = last_query_tel;
    }

    validate();
}

$(window).on('load', main);
